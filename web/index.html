<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Google Find My Tools - UI</title>

    <style>
      :root {
        --bg: #0b0f17;
        --card: #121a2a;
        --text: #e7eefc;
        --muted: #a9b7d6;
        --border: #22304a;
        --btn: #2f6fed;
        --btn2: #2a354c;
        --good: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }

      .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      h1 { font-size: 18px; margin: 0; font-weight: 650; }

      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.03);
        color: var(--muted);
        font-size: 13px;
      }

      .dot { width: 10px; height: 10px; border-radius: 999px; background: var(--muted); }
      .dot.good { background: var(--good); }
      .dot.warn { background: var(--warn); }
      .dot.bad  { background: var(--bad); }

      button {
        cursor: pointer;
        border: 0;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 650;
        color: white;
        background: var(--btn);
      }

      button.secondary {
        background: var(--btn2);
        color: var(--text);
        border: 1px solid var(--border);
      }

      button:disabled { opacity: 0.55; cursor: not-allowed; }

      .hint {
        margin-top: 10px;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.4;
      }

      .iframe-wrap {
        margin-top: 18px;
        border-radius: 14px;
        border: 1px solid var(--border);
        overflow: hidden;
        display: none;
      }
      .iframe-wrap.show { display: block; }

      iframe {
        width: 100%;
        height: 530px;
        border: 0;
        background: #000;
        display: block;
      }

      .error-box {
        margin-top: 14px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.08);
        color: #ffd0d0;
        white-space: pre-wrap;
        font-size: 12px;
      }

      .lang {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 13px;
      }

      select, input {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 10px;
        padding: 8px 10px;
        outline: none;
      }

      input { padding: 10px; }

      .devices-card { margin-top: 16px; }

      .section-title {
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: 650;
      }

      .list { margin-top: 10px; }

      .item {
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }

      .item-title { font-weight: 650; }
      .item-sub { color: var(--muted); font-size: 12px; }

      .split {
        margin-top: 14px;
        border-top: 1px solid var(--border);
        padding-top: 14px;
      }
    </style>
  </head>

  <body>
    <div id="app" class="wrap">
      <div class="card">
        <div class="topbar">
          <h1>{{ t('title') }}</h1>

          <div class="lang">
            <span>{{ t('language') }}</span>
            <select v-model="lang" @change="saveLang">
              <option value="en">English</option>
              <option value="fr">Français</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="status-pill">
            <span class="dot" :class="statusKind"></span>
            <span>{{ statusText }}</span>
          </div>

          <button :disabled="busy" @click="startFlow">{{ t('authenticate') }}</button>
          <button class="secondary" :disabled="busy" @click="refreshConnection">{{ t('refresh') }}</button>
        </div>

        <div class="hint">{{ t('hint') }}</div>

        <div v-if="errorMsg" class="error-box">{{ errorMsg }}</div>

        <div class="iframe-wrap" :class="{ show: iframeVisible }">
          <iframe :src="iframeUrl" title="noVNC"></iframe>
        </div>
      </div>

      <!-- Devices: visible only when authenticated -->
      <div class="card devices-card" v-if="connected">
        <div class="section-title">{{ t('devices') }}</div>

        <div class="row" style="margin-top:0;">
          <button class="secondary" :disabled="busyDevices" @click="loadDevices">{{ t('reloadDevices') }}</button>
        </div>

        <div class="list hint" v-if="devicesLoading">{{ t('loading') }}</div>

        <div class="list" v-else>
          <div v-if="devices.length === 0" class="hint">{{ t('noDevices') }}</div>

          <div v-for="(d, idx) in devices" :key="idx" class="item">
            <div class="item-title">{{ d.name || '(no name)' }}</div>
            <div class="item-sub">
              {{ (d.type || '') }} • {{ (d.id || '') }}
            </div>
          </div>
        </div>

        <div class="split">
          <div class="section-title">{{ t('addCustomDevice') }}</div>

          <div class="row">
            <input v-model="form.name" :placeholder="t('name')" style="flex:1; min-width:220px;" />
            <input v-model="form.model" :placeholder="t('model')" style="flex:1; min-width:180px;" />
          </div>

          <div class="row">
            <input v-model="form.manufacturer" :placeholder="t('manufacturer')" style="flex:1; min-width:220px;" />
            <input v-model="form.image_url" :placeholder="t('imageUrl')" style="flex:1; min-width:220px;" />
          </div>

          <div class="row">
            <button :disabled="busyAdd" @click="addCustom">{{ busyAdd ? t('adding') : t('add') }}</button>
            <div class="hint" v-if="addMsg">{{ addMsg }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vue 3 (inline) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script>
      const { createApp } = Vue;

      function detectLang() {
        const saved = localStorage.getItem("gfm_lang");
        if (saved === "en" || saved === "fr") return saved;
        const nav = (navigator.language || "").toLowerCase();
        return nav.startsWith("fr") ? "fr" : "en";
      }

      createApp({
        data() {
          return {
            i18n: null,
            lang: detectLang(),

            statusKind: "",         // good|warn|bad
            statusText: "…",
            errorMsg: "",

            connected: false,

            busy: false,
            iframeVisible: false,
            iframeUrl: "about:blank",
            authStarted: false,
            pollingTimer: null,

            // anti-loop for auto reauth
            autoReauthCooldownUntil: 0,

            // devices
            devices: [],
            devicesLoading: false,
            busyDevices: false,

            // add custom
            form: {
              name: "",
              model: "Custom Tracker",
              manufacturer: "GoogleFindMyTools",
              image_url: ""
            },
            busyAdd: false,
            addMsg: ""
          };
        },

        methods: {
          t(key) {
            const I = this.i18n || {};
            return (I[this.lang] && I[this.lang][key]) || (I.en && I.en[key]) || key;
          },

          saveLang() {
            localStorage.setItem("gfm_lang", this.lang);
            document.title = `${this.t("title")} - UI`;
            this.refreshConnection();
          },

          setStatus(kind, text) {
            this.statusKind = kind;
            this.statusText = text;
          },

          async apiFetch(url, opts) {
            const r = await fetch(url, opts || {});
            const text = await r.text();
            let j = null;
            try { j = text ? JSON.parse(text) : null; } catch { j = { error: text }; }
            return { ok: r.ok, status: r.status, json: j };
          },

          async apiGet(url) {
            const res = await this.apiFetch(url, { method: "GET" });
            if (!res.ok) throw res;
            return res.json;
          },

          async apiPost(url, bodyObj) {
            const opts = { method: "POST", headers: {} };
            if (bodyObj !== undefined) {
              opts.headers["Content-Type"] = "application/json";
              opts.body = JSON.stringify(bodyObj);
            }
            const res = await this.apiFetch(url, opts);
            if (!res.ok) throw res;
            return res.json;
          },

          formatApiError(res) {
            // res is {status, json}
            const j = res && res.json ? res.json : {};
            if (j && (j.message || j.error)) {
              return j.message || j.error;
            }
            return `HTTP ${res.status || "?"}`;
          },

          shouldAutoReauth() {
            const now = Date.now();
            return now >= this.autoReauthCooldownUntil;
          },

          armAutoReauthCooldown(ms) {
            this.autoReauthCooldownUntil = Date.now() + ms;
          },

          async triggerReauth(reasonText) {
            // avoid infinite loop spam
            if (!this.shouldAutoReauth()) return;

            this.connected = false;
            this.devices = [];
            this.addMsg = "";
            this.errorMsg = reasonText || this.t("authFailed");

            // cooldown 8s so device polling doesn't spam auth
            this.armAutoReauthCooldown(8000);

            // auto open iframe + start auth flow
            await this.startFlow();
          },

          async refreshConnection() {
            try {
              this.errorMsg = "";
              this.setStatus("warn", this.t("checking"));

              const s = await this.apiGet("/api/connection/status");
              this.connected = !!s.connected;

              if (this.connected) {
                this.setStatus("good", this.t("connected"));
                // optional: lazy load
                await this.loadDevices();
              } else {
                this.setStatus("bad", this.t("disconnected"));
                this.devices = [];
              }
            } catch (e) {
              this.setStatus("bad", this.t("serverError"));
              this.errorMsg = this.formatApiError(e);
            }
          },

          stopPolling() {
            if (this.pollingTimer) {
              clearInterval(this.pollingTimer);
              this.pollingTimer = null;
            }
          },

          async pollAuthStatus() {
            try {
              const st = await this.apiGet("/api/auth/status");

              if (st.running) {
                this.setStatus("warn", this.t("authenticating"));
                return;
              }

              if (st.done) {
                if (st.result && st.result.success) {
                  this.connected = true;
                  this.setStatus("good", this.t("connected"));
                  this.errorMsg = "";

                  // Close iframe on success
                  this.iframeVisible = false;
                  this.iframeUrl = "about:blank";

                  await this.loadDevices();
                } else {
                  this.connected = false;
                  this.setStatus("bad", this.t("authFailed"));
                  const errMsg = (st.result && st.result.error) ? st.result.error : "Unknown error";
                  this.errorMsg = errMsg;
                  // keep iframe visible on failure
                }

                this.authStarted = false;
                this.stopPolling();
                setTimeout(() => this.refreshConnection(), 700);
              }
            } catch (e) {
              this.setStatus("bad", this.t("serverError"));
              this.errorMsg = this.formatApiError(e);
            }
          },

          startPolling() {
            this.stopPolling();
            this.pollingTimer = setInterval(() => this.pollAuthStatus(), 800);
          },

          async startFlow() {
            // guard: if already running auth flow, don't restart
            if (this.authStarted) return;

            this.busy = true;
            this.errorMsg = "";

            try {
              this.setStatus("warn", this.t("startingVnc"));
              const nv = await this.apiPost("/api/novnc/start");
              if (!nv.iframe_url) throw { status: 500, json: { error: "noVNC start returned no iframe_url" } };

              this.iframeVisible = true;
              this.iframeUrl = nv.iframe_url;

              // start auth
              this.authStarted = true;
              this.setStatus("warn", this.t("authenticating"));
              await this.apiPost("/api/auth/start");
              this.startPolling();
            } catch (e) {
              this.setStatus("bad", this.t("failedToStart"));
              this.errorMsg = this.formatApiError(e);
              this.iframeVisible = false;
              this.iframeUrl = "about:blank";
              this.authStarted = false;
            } finally {
              this.busy = false;
            }
          },

          async loadDevices() {
            if (!this.connected) return;

            this.devicesLoading = true;
            this.busyDevices = true;

            try {
              const r = await this.apiGet("/api/devices");
              this.devices = Array.isArray(r.devices) ? r.devices : [];
            } catch (e) {
              const j = (e && e.json) ? e.json : {};
              // formatted reauth from backend
              if (e.status === 401 && j.code === "REAUTH_REQUIRED") {
                await this.triggerReauth(`${this.t("authFailed")}\n${j.details || ""}`);
                return;
              }
              this.errorMsg = `${this.t("devicesLoadFailed")}\n${this.formatApiError(e)}`;
            } finally {
              this.devicesLoading = false;
              this.busyDevices = false;
            }
          },

          async addCustom() {
            this.addMsg = "";
            if (!this.form.name || !this.form.name.trim()) {
              this.addMsg = this.t("nameRequired");
              return;
            }

            this.busyAdd = true;
            try {
              await this.apiPost("/api/devices/custom", {
                name: this.form.name.trim(),
                model: (this.form.model || "").trim(),
                manufacturer: (this.form.manufacturer || "").trim(),
                image_url: (this.form.image_url || "").trim()
              });

              this.addMsg = this.t("addedOk");
              await this.loadDevices();
            } catch (e) {
              const j = (e && e.json) ? e.json : {};
              if (e.status === 401 && j.code === "REAUTH_REQUIRED") {
                await this.triggerReauth(`${this.t("authFailed")}\n${j.details || ""}`);
                return;
              }
              this.addMsg = `${this.t("addFailed")} ${this.formatApiError(e)}`;
            } finally {
              this.busyAdd = false;
            }
          }
        },

        async mounted() {
          // load external JSON (must be external)
          try {
            const r = await fetch("/static/i18n.json", { cache: "no-store" });
            this.i18n = await r.json();
          } catch {
            this.i18n = { en: { title: "Google Find My Tools" }, fr: { title: "Google Find My Tools" } };
          }

          document.title = `${this.t("title")} - UI`;
          this.setStatus("warn", this.t("checking"));
          await this.refreshConnection();
        }
      }).mount("#app");
    </script>
  </body>
</html>
